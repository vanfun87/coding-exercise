name: Job Info and Feishu Notification

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
        environment:
        description: 'If not provided, test will run on **staging** env.'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - prod

jobs:
  staging:
    if: github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest  # ä½¿ç”¨å…è´¹ Linux è¿è¡Œç¯å¢ƒ
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Print Job Information
        run: |
          echo "Job Name: Staging"

  prod:
    if: github.event.inputs.environment == 'prod'
    runs-on: ubuntu-latest  # ä½¿ç”¨å…è´¹ Linux è¿è¡Œç¯å¢ƒ
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Print Job Information
        run: |
          echo "Job Name: PROD"

  notify_staging:
    runs-on: ubuntu-latest
    needs: staging
    if: always()
    steps:
      - name: Send Feishu Notification
        if: always()
        run: |
          STATUS=${{ job.status }}
          WORKFLOW="${{ github.workflow }}"
          URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          MESSAGE="GitHub Actions ä»»åŠ¡ **${WORKFLOW}** è¿è¡Œå®Œæˆ ğŸ‰\n
          ğŸ”¹ **çŠ¶æ€**: ${STATUS}\n
          ğŸ”¹ **ç¯å¢ƒ**: Staging\n
          ğŸ”¹ **è¯¦æƒ…**: [ç‚¹å‡»æŸ¥çœ‹](${URL})"

          echo "Message: ${MESSAGE}"

          curl -X POST "https://open.feishu.cn/open-apis/bot/v2/hook/cadf8f3a-c82e-46ee-98b8-7623f2789098" \
          -H "Content-Type: application/json" \
          -d '{
              "msg_type": "text",
              "content": {
                "text": "GitHub Actions Staging æ‰§è¡Œå®Œæˆ: ${{ github.repository }}\nWorkflow: ${{ github.workflow }}\nStatus: ${{ job.status }}\nURL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
          }'
          
  notify_prod:
    runs-on: ubuntu-latest
    needs: prod
    if: always()
    steps:
      - name: Send Feishu Notification
        if: always()
        run: |
          STATUS=${{ job.status }}
          WORKFLOW="${{ github.workflow }}"
          URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          MESSAGE="GitHub Actions ä»»åŠ¡ **${WORKFLOW}** è¿è¡Œå®Œæˆ ğŸ‰\n
          ğŸ”¹ **çŠ¶æ€**: ${STATUS}\n
          ğŸ”¹ **ç¯å¢ƒ**: Staging\n
          ğŸ”¹ **è¯¦æƒ…**: [ç‚¹å‡»æŸ¥çœ‹](${URL})"

          echo "Message: ${MESSAGE}"

          curl -X POST "https://open.feishu.cn/open-apis/bot/v2/hook/cadf8f3a-c82e-46ee-98b8-7623f2789098" \
          -H "Content-Type: application/json" \
          -d '{
              "msg_type": "text",
              "content": {
                "text": "GitHub Actions PROD æ‰§è¡Œå®Œæˆ: ${{ github.repository }}\nWorkflow: ${{ github.workflow }}\nStatus: ${{ job.status }}\nURL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
          }'
